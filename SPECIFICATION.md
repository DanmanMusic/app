# Danmans Virtual Ticket App - Functional Specification

## 1. Overview

This document outlines the functional requirements for the Danmans Virtual Ticket App, a mobile application designed to manage student rewards using a virtual ticket system within a music school or similar educational setting. The app caters to different user roles: **Admin**, **Teacher**, **Student**, and **Parent**. Data fetching and state management are primarily handled using TanStack Query, interacting with defined API endpoints (currently mocked via MSW).

## 2. User Creation, Linking, and Authentication

- **Account Creation:** Exclusively performed by the **Admin** role via a secure Admin interface. Admin creates accounts for **Admin**, **Teacher**, and **Student** users. (Parents are not explicitly created via this interface). Requires first name, last name, role selection. Nickname is optional. For Students, Admin can link initial Teacher(s) and Instrument(s). Uses `POST /api/users`.
- **User Linking:** Admin is responsible for establishing relationships via the Admin interface, likely through update operations (`PATCH /api/users/:id`) modifying fields like `linkedTeacherIds` (on Student), `instrumentIds` (on Student). Parent linking mechanism relies on QR code flow.
- **User Deactivation/Deletion (Admin Action):**
  - Admins can manage user accounts via their interface.
  - **Deactivation/Reactivation (Primary):** Uses `PATCH /api/users/:id/status` endpoint. A confirmation modal should appear. Deactivation sets `status` to `'inactive'`, prevents login, removes from active lists. Data is retained. Reactivation sets status to `'active'`. Cascading logic (Sec 8) is a backend concern.
  - **Permanent Deletion (Secondary):** Uses `DELETE /api/users/:id` endpoint. Requires explicit confirmation via dedicated modal. Removes user record and associated data (backend policy). Cascading logic (Sec 8) is a backend concern.
- **Authentication (Non-Admin Users - Teacher, Student, Parent):**
  - Initial login facilitated by unique QR code generated by **Admin** or **Teacher** (via UI action, associated with a Student ID).
  - Mobile app scans QR code: Authenticates as **Student**, implicitly authenticates **Parent** session linked to that Student. Secure token storage needed.
  - **Teacher Login:** Separate mechanism (e.g., username/password via dedicated login screen - TBD, requires backend auth implementation).
  - **Session Management:** App stores authentication tokens securely (`AuthContext` manages auth state). Parent sessions tied to linked Students.

## 3. Core Features by Role

### 3.1. Admin

- **User Management:** CRUD via API calls (`GET /api/students`, `GET /api/teachers`, `GET /api/parents`, `POST /api/users`, `PATCH /api/users/:id`, `DELETE /api/users/:id`, `PATCH /api/users/:id/status`). Pagination handled via hooks (`usePaginated*`).
- **Instrument Management:** CRUD via API (`/api/instruments`).
- **Task Library Management:** CRUD via API (`/api/task-library`).
- **Task Assignment:** Assigns tasks via API (`POST /api/assigned-tasks`). Can use library items or create Ad-Hoc tasks.
- **Task Verification:** Views pending tasks (likely via `GET /api/assigned-tasks?assignmentStatus=pending`), approves/rejects via API (`PATCH /api/assigned-tasks/:id`).
- **Rewards Catalog Management:** CRUD via API (`/api/rewards`).
- **Ticket Adjustments:** Manually adjusts via API (`POST /api/ticket-adjustments`).
- **History Viewing:** Views global history via API (`GET /api/ticket-history`). Pagination handled via hook (`usePaginatedTicketHistory`).
- **Announcements:** CRUD via API (`/api/announcements`).

### 3.2. Teacher

- **View Linked Students:** Fetches students via API (`GET /api/students` or dedicated teacher endpoint - TBD) and filters locally or relies on backend filtering. Displays key details (name, instruments, balance fetched via `GET /api/students/:id/balance`).
- **View Student Profile:** Navigates to a view fetching student data (`GET /api/users/:id`, `GET /api/students/:id/balance`), assigned tasks (`GET /api/assigned-tasks?studentId=...`), and history (`GET /api/ticket-history?studentId=...`). Pagination handled by hooks.
- **Task Assignment:** Assigns via API (`POST /api/assigned-tasks`).
- **Task Verification:** Views pending tasks (filtered `GET /api/assigned-tasks?assignmentStatus=pending` or dedicated endpoint), verifies via API (`PATCH /api/assigned-tasks/:id`).
- **QR Code Generation:** UI action triggering backend process (TBD).

### 3.3. Student

- **Dashboard:** Fetches own user data (`GET /api/users/:id`), balance (`GET /api/students/:id/balance`), goal info, recent history/tasks via relevant API calls.
- **Task List:** Fetches assigned tasks (`GET /api/assigned-tasks?studentId=...`), displays status. Marks complete via API (`PATCH /api/assigned-tasks/:id`). Pagination handled by hook.
- **Rewards Catalog:** Fetches via API (`GET /api/rewards`). Views progress, sets goal (local state or backend TBD). Redemption (TBD - `POST /api/reward-redemptions`).
- **Ticket History:** Fetches personal history via API (`GET /api/ticket-history?studentId=...`). Pagination handled by hook.
- **Announcements:** Fetches via API (`GET /api/announcements`).

### 3.4. Parent

- **Student Selection:** Fetches parent data (`GET /api/users/:id`) to get linked IDs, then fetches linked student data (multiple `GET /api/users/:id` calls managed via `useQueries`).
- **View Student Dashboard:** Renders `StudentView` component, passing the selected child's ID. `StudentView` handles its own data fetching based on the ID.
- **Mark Tasks Complete:** Can mark child's tasks complete via API (`PATCH /api/assigned-tasks/:id`).
- **Link Additional Students:** Initiates QR code scanning flow.

## 4. Task Workflow

1.  **Creation/Assignment:** `POST /api/assigned-tasks`.
2.  **Completion:** `PATCH /api/assigned-tasks/:id` (sets `isComplete: true`).
3.  **Verification Queue:** Fetched via `GET /api/assigned-tasks`.
4.  **Verification:** `PATCH /api/assigned-tasks/:id` (sets `verificationStatus`, `verifiedById`, `verifiedDate`, `actualPointsAwarded`). Ticket balance updated on backend/via mock handler triggered by PATCH.
5.  **Re-assign (Optional):** Triggers `POST /api/assigned-tasks` with original details.
6.  **History:** Backend/mock handler creates `TicketTransaction` record on successful verification/adjustment/redemption.

## 5. Ticket Economy

- **Earning:** Task completion (`PATCH /api/assigned-tasks/:id`), Manual adjustment (`POST /api/ticket-adjustments`).
- **Spending (Redemption):** `POST /api/reward-redemptions`.
- **Balance:** Fetched via `GET /api/students/:id/balance`. Updated implicitly by backend/mock handlers during task verification, adjustments, redemptions.
- **History:** Logged by backend/mock handlers. Fetched via `GET /api/ticket-history`.

## 6. Data Models (Conceptual)

- **User:** `id`, `role`, `firstName`, `lastName`, `nickname?`, `status`, `linkedStudentIds?`, `linkedTeacherIds?`, `instrumentIds?`, (`hashedPassword`?, `authTokens`? - Backend concerns).
- **Instrument:** `id`, `name`, `iconUrl?`.
- **TaskLibraryItem:** `id`, `title`, `description`, `baseTickets`.
- **AssignedTask:** `id`, `studentId`, `assignedById`, `assignedDate`, `taskTitle`, `taskDescription`, `taskBasePoints`, `isComplete`, `completedDate?`, `verificationStatus?`, `verifiedById?`, `verifiedDate?`, `actualPointsAwarded?`.
- **RewardItem:** `id`, `name`, `cost`, `description?`, `imageUrl?`.
- **TicketTransaction:** `id`, `studentId`, `timestamp`, `amount`, `type`, `sourceId`, `notes?`.
- **Announcement:** `id`, `title`, `message`, `date`, `type`, `relatedStudentId?`.

## 7. Non-Functional Requirements

- **Platform:** Mobile App (iOS & Android via React Native/Expo). Potential for Admin web interface later.
- **Security:** Secure storage of credentials/tokens. Input validation. Role-based access control enforced by backend.
- **Usability:** Intuitive navigation, clear feedback to users. Offline capability is NOT a requirement for V1.
- **Performance:** App should be responsive. Lists should handle moderate amounts of data smoothly (pagination/virtualization for large lists).

## 8. Cascading Logic for Deactivation/Deletion

- **Deactivating a Student:** Backend sets status, clears links (?). Frontend invalidates student/teacher/parent lists.
- **Reactivating a Student:** Backend sets status. Frontend invalidates lists. Links NOT auto-restored.
- **Deactivating a Teacher:** Backend sets status, clears links from students (?). Frontend invalidates lists.
- **Deactivating an Admin/Parent:** Backend sets status. Frontend invalidates lists.
- **Permanently Deleting a Student:** Backend removes record, associated data (tasks/history TBD), clears parent links. Frontend invalidates lists.
- **Permanently Deleting a Teacher:** Backend removes record, clears student links. Frontend invalidates lists.
- **Permanently Deleting an Admin/Parent:** Backend removes record. Frontend invalidates lists.