# Danmans Virtual Ticket App - Functional Specification

This document details the functional requirements, user roles, and workflows for the Danmans Music Store Virtual Ticket and Rewards application.

## 1. User Roles

The application supports four distinct user roles with specific permissions and interfaces:

- **Admin (Store Manager):** Has overarching control. Responsible for system setup, user management, managing core data (tasks library, rewards catalog, instrument list), manual overrides/redemption processing, and generating login QR codes for _any_ user. Access likely via secure login (e.g., username/password).
- **Teacher (Danmans Employee):** Manages their assigned students' tasks and progress. Assigns and verifies tasks to award tickets. Can view student progress, including their assigned instruments. Can generate login QR codes for students _linked to them_. Logs in via Admin-generated QR code.
- **Student (Music Student):** The primary recipient of tickets and rewards. Views assigned tasks, marks completion, tracks balance, and browses rewards. Can view their assigned instrument(s). Logs in via Admin- or Teacher-generated QR code (older students) or accessed via Parent login.
- **Parent (of Student):** Can link to one or more children's profiles, monitor their progress, mark tasks complete on their behalf, and view their child's ticket balance, history, and assigned instrument(s). Access via Admin-generated QR code ("Parent Link QR").

## 2. User Creation, Linking, and Authentication

- **Account Creation:** Exclusively performed by the **Admin** role via a secure Admin interface. Admin creates accounts for **Admin**, **Teacher**, and **Student** users. (Parents are not explicitly created via this interface).
- **User Linking:** Admin is responsible for establishing relationships via the Admin interface:
  - Linking **Student** accounts to **Teacher** accounts (many-to-many relationship managed via `linkedTeacherIds` field on Student record).
  - Linking **Student** accounts to **Parent** access (mechanism detailed below). A single Parent device/session can be linked to multiple Students.
  - Assigning **Instrument(s)** to **Student** accounts (1-to-many relationship).
- **Authentication (Non-Admin Users - Teacher, Student, Parent):**
  - Initial login is facilitated by a unique QR code generated by an **Admin** or **Teacher**.
  - Admin interface has actions like "Generate Login QR for [Teacher]", "Generate Login QR for [Student]", and "Generate Parent Link QR for [Student]".
  - Teacher interface (within a student's detail view) has an action like "Generate Login QR for [Student]".
  - Teachers install the app, select "Login", and scan their _Admin-generated_ QR code to log into their account.
  - Students install the app, select "Login", and scan the QR code generated for them by either an **Admin** or one of their **linked Teachers**.
  - Parents install the app, select "Login", and scan the "Parent Link QR" generated by an **Admin** for their child. This logs them in and links their session to that Student. If they have multiple children, they scan a Parent Link QR for _each_ child they want to access on that device.
  - For a Parent acting _as_ a young student, they would scan the student's primary "Login QR" (generated by Admin or Teacher) on their device. This logs the device in as that student.
- **Subsequent Logins & Recovery:** A mechanism is needed for users to log back in if they log out, uninstall, or get a new device. This likely involves Admins or Teachers generating new QR codes or providing an alternative recovery method (TBD). QR codes should ideally be single-use or time-limited for security.
- **Parent Multi-Child Access:**
  - When a Parent logs in via a "Parent Link QR" and is linked to multiple Students, the initial screen is a Family Dashboard/selector showing linked children with key info (e.g., name, balance, instrument(s)).
  - Parent selects a child to enter their specific Student view.
  - Option to "Add Another Student" in the Parent view allows scanning additional Parent Link QRs (generated by Admin) to link more children to this Parent session/device.

_(**Clarification on Parent Auth:** The "Parent Link QR" generated by Admin is the primary mechanism. This implies the Parent 'session' or 'link' is managed per-device, potentially tied to the QR data scanned, rather than a full, Admin-managed Parent user account in the same way as Teachers/Students.)_

## 3. Task Management

Defines the lifecycle of tasks assigned to students, leading to ticket awards.

- **Task Creation:**
  - **Admins** manage a central **Task Library** (Title, Description, Base Points Available) via the Admin interface.
  - **Teachers** can assign tasks from the Admin Task Library.
  - **Teachers** can create and assign custom tasks (Title, Description, Base Points Available) not in the library, specifically for their students.
- **Task Assignment:**
  - **Teachers** assign tasks to one or multiple students linked to them.
  - **Teachers** can potentially assign tasks to students not directly linked to them (e.g., by searching, if permissions allow).
  - **Admins** can assign tasks (from library or custom) to individual students or groups. Admin can specifically filter student selection for **Challenge Tasks** by the **instrument(s)** the students play.
  - Tasks are visible to the assigned Student, their linked Parent(s), the assigning Teacher(s), other linked Teachers, and all Admins.
- **Task Completion (Student/Parent Action):**
  - Assigned tasks appear in the Student's view (and Parent's view when accessing the child).
  - Either the **Student** (if using their own login) or a linked **Parent** (acting on behalf of the Student) can mark an assigned task as "Complete".
- **Task Verification (Teacher/Admin Action):**
  - Any **Teacher** linked to the student or any **Admin** can view tasks marked as "Complete" for that student.
  - When verifying, the Teacher/Admin selects a status: **Verified**, **Partial Complete**, or **Incomplete**.
  - A secondary prompt appears with a slider/input defaulting to 100%, 50%, or 0% of the base Points Available based on the selected status. The Teacher/Admin can **adjust this final points value**.
  - Upon confirmation, the **adjusted points** are added to the student's ticket balance.
  - Immediately after, the Teacher/Admin is prompted with the option to "Re-assign" this same task to the student.
- **Task Editing/Deletion:** Assigned tasks can be edited or deleted by the original assigner or an Admin. _Clarification needed:_ Can tasks be edited/deleted after being marked complete/verified? (Likely not after verification, maybe archived).
- **Task History:** A history of assigned and verified tasks (including status, base points, and _actual points awarded_) is maintained and viewable by the assigned Student, their linked Parent(s), all Teachers linked to the student, and all Admins.

## 4. Ticket Management

Defines how virtual tickets are tracked, awarded, and managed.

- **Earning Tickets:** Primarily earned through the **Teacher/Admin verification** of tasks with adjustable points.
- **Manual Adjustments:**
  - **Admins only** can manually add or subtract tickets from a student's balance via the Admin interface.
  - Manual adjustments (not tied to redemption) require a **mandatory note/reason**. This is used for onboarding existing physical tickets or correcting errors.
- **Redemption:**
  - **No in-app student/parent redemption process.** Physical redemption happens at the store.
  - The app facilitates recording "big ticket" redemptions: An **Admin** uses a specific action "Redeem [Reward Item] for [Student]" (likely from the Admin interface).
  - This Admin action automatically **subtracts the exact ticket cost** of the selected item from the student's balance.
  - This action creates a distinct "Redeemed" entry in the Ticket Transaction History.
  - This action also **triggers a public announcement** visible to all users (on the Announcements/Challenge Tasks screen) celebrating the student's achievement.
- **Ticket Balance Visibility:** The current virtual ticket balance for any student is visible to **all logged-in users** who have permission to view that student (the student themselves, their linked Parents, their linked Teachers, and all Admins).
- **Ticket Transaction History:** A detailed history of all ticket movements (task awards, manual adds, manual subtracts, redemptions) is maintained. Each entry includes Date/Timestamp, Amount (+/-), and Reason/Source. The full history is viewable by **all logged-in users** who have permission to view that student.

## 5. Rewards Catalog

Details the list of items students can redeem tickets for and its presentation.

- **Catalog Management:** Exclusively managed by **Admins** via the Admin interface.
- **Item Details:** Each item includes **Item Name**, **Ticket Cost**, **Image/Photo**, and optional **Description**.
- **Catalog Visibility:**
  - Visible to **all logged-in users**.
  - Visible to **non-logged-in users** as a public promotional feature for Danmans.
- **Presentation:**
  - Displayed in a sortable list/grid, defaulting to **cheapest to most expensive**.
  - **For logged-in users viewing a student's context:** Clearly indicates if the student has enough tickets or how many more are needed for each item. May visually separate affordable items.
  - **For non-logged-in users (Public View):** Shows items, costs, image, description, but no student-specific eligibility info.
- **Integration:** The catalog data is used by the Admin "Redeem for..." action to deduct the correct ticket cost and is key for the public announcement feature.

## 6. Parent View

Defines the interface and capabilities for users logged in as a Parent.

- **Core:** Provides access to the standard Student view experience but allows managing multiple linked children from one login.
- **Initial View:** If multiple children are linked, starts on a Family Dashboard/selector listing children with key info (name, balance, instrument(s)). If only one child, may go directly to that child's Student view.
- **Navigation:** Clear way to switch between linked children's Student views from the Family Dashboard/selector.
- **Capabilities (when viewing a specific child):** Same capabilities as a Student logged in as that child (View Balance, View Tasks, Mark Complete, View History, Browse Catalog with eligibility, View Announcements/Challenges, Set Wishlist item), plus viewing the child's assigned instrument(s).
- **Linking More Children:** Option to "Add Another Student" (e.g., on Family Dashboard) activates camera to scan a new "Parent Link QR" generated by Admin, linking another child to this Parent session/device.

## 7. Key Considerations and Potential Blind Spots

- **Backend:** A robust backend system is required to store all user data, task assignments, ticket balances, history, catalog information, instrument list, and announcement information persistently and securely. Needs to support role-based access control and the 1-to-many relationship between Students and Instruments, and many-to-many between Students and Teachers. An Admin Web UI for management is highly recommended.
- **Real-time Updates:** Important for a good UX â€“ task status, ticket balances, and announcements should update promptly across devices.
- **Push Notifications:** Essential for notifying users of key events (Task assigned, Task verified/tickets awarded, Reward redeemed, New Announcement/Challenge).
- **UI/UX:** Interfaces need to be intuitive and tailored for each role (especially the simple Student/Parent view vs. the more complex Teacher/Admin views). Gamification elements (progress bars, animations) are key for student engagement. Displaying instruments clearly in relevant views (Student, Parent, Teacher, Admin) is needed.
- **Security:** Protecting user data and preventing fraudulent ticket adjustments requires careful attention to authentication, authorization (permissions), and backend security. QR codes need a revocation/recovery mechanism, especially if they are long-lived or reusable.
- **Onboarding Existing Physical Tickets:** The Admin manual adjustment feature is explicitly needed for this initial data migration. Also need to ensure existing students are assigned instruments and linked to teachers.
- **Gamification & Engagement:** Beyond mechanics, consider visual design and celebratory elements (e.g., when tickets are awarded or goals are reached). Instrument-specific challenges add a layer of engagement.
- **Offline Capability:** Determine if any features need to work offline (e.g., viewing current balance/tasks, viewing assigned instruments). Marking complete offline could sync later. Verification/Redemption/Management/QR Generation likely requires online access.

## 8. Undecided Elements

- **Teacher/Admin Task Visibility & Verification Scope:** Clarified: Any Teacher _linked_ to the student or any Admin can verify.
- **Task Editing/Deletion Restrictions:** Precisely when and by whom tasks can be edited or deleted, especially after completion or verification. (Current assumption: Cannot edit/delete after verification).
- **Instrument Management Detail:** How complex does instrument management need to be? Just a name? Categories? (Current assumption: Just name is sufficient for now).
- **Parent Authentication Persistence:** How long does a Parent Link QR scan grant access on a device? Does it persist across app closes? How is it revoked?
