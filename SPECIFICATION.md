# Danmans Virtual Ticket App - Functional Specification

## 1. Overview

This document outlines the functional requirements for the Danmans Virtual Ticket App, a mobile application designed to manage student rewards using a virtual ticket system within a music school or similar educational setting. The app caters to different user roles: **Admin**, **Teacher**, **Student**, and **Parent**.

## 2. User Creation, Linking, and Authentication

- **Account Creation:** Exclusively performed by the **Admin** role via a secure Admin interface. Admin creates accounts for **Admin**, **Teacher**, and **Student** users. (Parents are not explicitly created via this interface). Requires first name, last name, role selection. Nickname is optional. For Students, Admin can link initial Teacher(s) and Instrument(s).
- **User Linking:** Admin is responsible for establishing relationships via the Admin interface:
  - Linking **Student** accounts to **Teacher** accounts (many-to-many relationship managed via `linkedTeacherIds` field on Student record).
  - Linking **Student** accounts to **Parent** access (mechanism detailed below). A single Parent device/session can be linked to multiple Students.
  - Assigning **Instrument(s)** to **Student** accounts (1-to-many relationship).
- **User Deactivation/Deletion (Admin Action):**
  - Admins can manage user accounts via their interface (typically from a user detail view).
  - **Deactivation/Reactivation (Primary):** When an Admin initiates the "Manage Status" action for a user, a confirmation modal should appear displaying the user's current status (Active/Inactive). The primary actions should be "Deactivate User" (if currently active) or "Reactivate User" (if currently inactive). Deactivation should set the user's `status` to `'inactive'`, prevent login, and remove them from standard active lists (e.g., teacher's student list, student selection modals). Data (history, balance, etc.) should be retained. Reactivation sets the status back to `'active'`. Cascading logic applies (see Section 8).
  - **Permanent Deletion (Secondary):** The status management modal should also offer a secondary, clearly marked "Permanently Delete User" option. This action requires explicit confirmation via a **dedicated confirmation modal** detailing the irreversible nature of the action before proceeding. It removes the user's record and associated data according to retention policies (TBD). Cascading logic applies (see Section 8).
- **Authentication (Non-Admin Users - Teacher, Student, Parent):**
  - Initial login is facilitated by a unique QR code generated by an **Admin** or **Teacher**.
  - **QR Code Generation (Admin/Teacher):** Can generate a temporary, single-use QR code associated with a specific **Student** account. This is done via an action in the Admin/Teacher interface (e.g., "Login (QR)" button on student detail).
  - **QR Code Scanning (Mobile App):** The main login screen of the mobile app features a "Scan QR Code" button. Upon scanning a valid, unexpired code generated for a Student:
    - The app authenticates as that **Student**.
    - The app _also_ implicitly authenticates a **Parent** session linked to that Student. The app should store the necessary credentials/tokens to maintain both the Student and Parent sessions securely.
  - **Teacher Login:** Teachers log in using a separate mechanism (e.g., username/password, potentially set up by Admin during creation - TBD, requires dedicated login screen).
  - **Session Management:** The app needs to securely store authentication tokens or session information to keep users logged in across app launches. Needs robust logout functionality. Parent sessions are tied to the linked Student(s) authenticated via QR code. If all linked students become inactive/deleted, the parent session should effectively end or prompt for a new QR scan.

## 3. Core Features by Role

### 3.1. Admin

- **User Management:** Create, view, edit, deactivate, reactivate, and permanently delete **Admin**, **Teacher**, and **Student** user accounts. Manage linking between Students and Teachers. Manage Instrument assignments for Students.
- **Instrument Management:** Create, Read, Update, Delete (CRUD) available instruments within the system (e.g., Piano, Guitar, Violin).
- **Task Library Management:** CRUD operations for predefined, reusable tasks (e.g., "Practice 15 minutes", "Learn Scale"). Each library task has a title, description, and base ticket value.
- **Task Assignment:** Assign tasks to students. Can assign tasks from the **Task Library** or create **Ad-Hoc Tasks** with custom titles, descriptions, and point values directly during assignment. The assigned task record stores a snapshot of the title, description, and base points at the time of assignment, independent of later changes to the Task Library.
- **Task Verification:** View list of completed tasks awaiting verification. Approve ('verified'), partially approve ('partial' with adjusted points), or mark as incomplete ('incomplete'). Verification records the verifier ID and timestamp. Awarded tickets are added to the student's balance upon verification ('verified' or 'partial').
- **Rewards Catalog Management:** CRUD operations for reward items available for students to redeem with tickets. Each reward has a name, ticket cost, optional description, and optional image URL.
- **Ticket Adjustments:** Manually add or subtract tickets from a student's balance with an optional note (e.g., correcting errors, initial transfer).
- **History Viewing:** View a global transaction history log for all students.
- **Announcements:** Create, edit, and delete system-wide announcements visible to Students and Parents.

### 3.2. Teacher

- **View Linked Students:** See a list of **active** students linked to their account, including key details like name, instrument(s), and current ticket balance.
- **View Student Profile:** Access a detailed view for a linked student, showing their assigned tasks, ticket history, balance, and instruments.
- **Task Assignment:** Assign tasks to linked students (from Task Library or Ad-Hoc).
- **Task Verification:** View a list of pending verifications _only_ for tasks completed by their linked students. Perform verification actions (verified, partial, incomplete) for these tasks.
- **QR Code Generation:** Generate login QR codes for their linked students.

### 3.3. Student

- **Dashboard:** View current ticket balance, assigned instrument(s), currently set goal (if any), and potentially a summary of recent activity or pending tasks.
- **Task List:** View assigned tasks, their status (Assigned, Complete-Pending, Verified), points awarded (if verified), and completion/verification dates. Mark assigned tasks as complete.
- **Rewards Catalog:** View available rewards, their costs, and potentially images/descriptions. View progress towards a set goal reward. Set or change their goal reward. **(Redemption possibly initiated here, but confirmation/fulfillment might involve Teacher/Admin - TBD)**.
- **Ticket History:** View their personal transaction history (tickets earned, spent, adjusted).
- **Announcements:** View announcements posted by Admins.

### 3.4. Parent

- **Student Selection:** If linked to multiple students, view a list of linked students to select from. If linked to only one, may bypass selection screen.
- **View Student Dashboard:** Access the selected child's **Student View** (Dashboard, Tasks, Rewards, History, Announcements).
- **Mark Tasks Complete:** Can mark their child's assigned tasks as complete.
- **Link Additional Students:** Initiate the process to link another student account via QR code scanning (requires Admin/Teacher to generate the code).

## 4. Task Workflow

1.  **Creation/Assignment:** Admin/Teacher assigns a task (Library or Ad-Hoc) to a Student. The `AssignedTask` record is created, storing student ID, assigner ID, assigned date, and the specific task details (title, description, base points). Initial status is 'Assigned'.
2.  **Completion:** Student/Parent marks the task as complete in the app. The `AssignedTask` record is updated: `isComplete` = true, `completedDate` set, `verificationStatus` set to 'pending'.
3.  **Verification Queue:** Task appears in the queue for linked Teacher(s) and potentially Admins.
4.  **Verification:** Teacher/Admin reviews the pending task.
    - **Approve (Verified):** Sets `verificationStatus`='verified', `verifiedDate`, `verifiedById`, `actualPointsAwarded` (defaults to `taskBasePoints`). Tickets added to balance.
    - **Partial Approve (Partial):** Sets `verificationStatus`='partial', `verifiedDate`, `verifiedById`, `actualPointsAwarded` (set to adjusted value by verifier). Tickets added to balance.
    - **Incomplete:** Sets `verificationStatus`='incomplete', `verifiedDate`, `verifiedById`. No tickets awarded. Task remains 'complete'. _(Alternatively, could reset `isComplete`=false? TBD - Current implementation keeps it complete)_.
    - **Re-assign (Optional):** A verification action might include an option to quickly re-assign the _same_ task (creating a new `AssignedTask` record).
5.  **History:** A `TicketTransaction` record is created for verified/partial awards.

## 5. Ticket Economy

- **Earning:** Tickets are primarily earned by completing tasks and having them verified ('verified' or 'partial'). Admins can also manually add tickets.
- **Spending (Redemption):** Students redeem tickets for items in the Rewards Catalog. Redemption deducts tickets from the balance and creates a transaction record. (Mechanism for reward fulfillment is outside the scope of this initial spec - assumed physical).
- **Balance:** Each student has a running ticket balance.
- **History:** All ticket transactions (awards, redemptions, adjustments) are logged with timestamps, amounts, types, and related source IDs (task assignment ID, reward ID, manual adjustment ID).

## 6. Data Models (Conceptual)

_(High-level, not exhaustive schema)_

- **User:** `id`, `role` (admin, teacher, student, parent), `firstName`, `lastName`, `nickname` (opt), `status` ('active', 'inactive'), `linkedStudentIds` (for parent), `linkedTeacherIds` (for student), `instrumentIds` (for student), `hashedPassword` (for teacher/admin - TBD), `authTokens` (TBD).
- **Instrument:** `id`, `name`, `iconUrl` (opt).
- **TaskLibraryItem:** `id`, `title`, `description`, `baseTickets`.
- **AssignedTask:** `id`, `studentId`, `assignedById`, `assignedDate`, `taskTitle`, `taskDescription`, `taskBasePoints`, `isComplete` (bool), `completedDate` (opt), `verificationStatus` (opt: 'pending', 'verified', 'partial', 'incomplete'), `verifiedById` (opt), `verifiedDate` (opt), `actualPointsAwarded` (opt).
- **RewardItem:** `id`, `name`, `cost`, `description` (opt), `imageUrl` (opt).
- **TicketTransaction:** `id`, `studentId`, `timestamp`, `amount` (+/-), `type` (task_award, redemption, manual_add, manual_subtract), `sourceId` (AssignedTask ID, RewardItem ID, etc.), `notes` (opt).
- **Announcement:** `id`, `title`, `message`, `date`, `type` (e.g., 'general', 'redemption_celebration'), `relatedStudentId` (opt).

## 7. Non-Functional Requirements

- **Platform:** Mobile App (iOS & Android via React Native/Expo). Potential for Admin web interface later.
- **Security:** Secure storage of credentials/tokens. Input validation. Role-based access control enforced by backend.
- **Usability:** Intuitive navigation, clear feedback to users. Offline capability is NOT a requirement for V1.
- **Performance:** App should be responsive. Lists should handle moderate amounts of data smoothly (pagination/virtualization for large lists).

## 8. Cascading Logic for Deactivation/Deletion

- **Deactivating a Student:**
  - Set student `status` to 'inactive'.
  - Remove student ID from `linkedTeacherIds` array of all linked Teachers.
  - For each linked Parent:
    - Remove student ID from Parent's `linkedStudentIds`.
    - If Parent's `linkedStudentIds` is now empty, **delete** the Parent user record. Check if deleted parent needs logout.
  - Check if deactivated student needs logout.
- **Reactivating a Student:**
  - Set student `status` to 'active'.
  - (Note: Links to Teachers/Parents are NOT automatically restored).
- **Deactivating a Teacher:**
  - Set teacher `status` to 'inactive'.
  - Remove teacher ID from `linkedTeacherIds` array of all previously linked Students.
  - Check if deactivated teacher needs logout.
- **Deactivating an Admin/Parent:**
  - Set user `status` to 'inactive'.
  - Check if deactivated user needs logout. (No link cleanup needed).
- **Permanently Deleting a Student:**
  - Remove Student record.
  - Remove student ID from `linkedStudentIds` array of all linked Parents (Parent record is NOT deleted).
  - Backend Strategy Needed: Decide whether to delete associated `AssignedTask` and `TicketTransaction` records or anonymize them. (Mock keeps them for now).
  - Check if deleted student needs logout.
- **Permanently Deleting a Teacher:**
  - Remove Teacher record.
  - Remove teacher ID from `linkedTeacherIds` array of all previously linked Students.
  - Check if deleted teacher needs logout.
- **Permanently Deleting an Admin/Parent:**
  - Remove User record.
  - Check if deleted user needs logout.
